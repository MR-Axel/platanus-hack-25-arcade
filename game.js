let W=800,H=600,STICK_H=40,STICK_W=8,WALL_SPACING=280,PORTAL_W=100,WALL_THICK=8,MIN_PORTAL=40,MAX_PORTAL=W-120,TROLL_PROB=.025,TROLL_DIST=150,sc=0,m=0,gm=0,diff=1,p1,p2,walls=[],cam,g,spd=2,t=0,timeLimit=180,colors=[65535,16711935,16776960],nextId=0,snd,txts={},baseSpeed=3.5,combo=0,maxCombo=0,portals=0,lives1=3,lives2=3,achv={},ranking=[],em={},musicTime=0,deathSlowdown=0,mom=1,countdown=-1,achvShow=0,motivShow=0,trollsDodged=0,invincible1=0,invincible2=0,menuSel=0,nameInput="",nameRow=0,nameCol=0,onAcceptButton=0,powerups=[],activePowers={slowmo:0,shield1:0,shield2:0,star:0,vision:0,speed:0},bugs=[],nearMiss=0,bossWave=0,chromatic=0,zoom=1,musicMuted=0,trail1=[],trail2=[],comboAnim=0,rouletteTime=0,lastRouletteT=0,musicVol=0,hs=0,particles=[],keyHoldTime=0,lastKeyDir="",floatingTexts=[],lastComboMsg=0,spin1Angle=0,spin2Angle=0,spin1Center={x:0,y:0},spin2Center={x:0,y:0},spin1Particles=[],spin2Particles=[],P1_COLOR=52479,P2_COLOR=16750848,UNIFIED_COLOR=10040319,DEATH_PORTAL_COLOR=16711680,DIFF_MULTS=[.7,1,1.4,2],DIFF_NAMES=["BABY","NORMAL","HARD","INSANE"],MODE_NAMES=["ENDLESS","TIME ATTACK","PERFECT RUN"],POWERUP_TYPES=["slowmo","shield","star","vision","speed","heart"],POWERUP_COLORS=[65535,65280,16776960,16711935,16746496,16711782],ALPHABET_GRID=["ABCDEFGHIJ","KLMNOPQRST","UVWXYZ    ","0123456789","    <     "],cfg={type:Phaser.AUTO,width:W,height:H,backgroundColor:"#000",scene:{create:create,update:update}};function blendColor(e,t,a){var i=e>>16&255,n=e>>8&255,e=255&e,s=t>>8&255,o=255&t;return Math.round(i+((t>>16&255)-i)*a)<<16|Math.round(n+(s-n)*a)<<8|Math.round(e+(o-e)*a)}function showFloatingText(e,t,a,i){floatingTexts.push({text:e,x:t,y:a,life:1.5,color:i})}function updateFloatingTexts(t){for(let e=floatingTexts.length-1;0<=e;e--){var a=floatingTexts[e];a.life-=.001*t,a.y-=.05*t,a.life<=0&&floatingTexts.splice(e,1)}}function drawFloatingTexts(){for(var t of floatingTexts){var e=Math.min(1,t.life);g.fillStyle(t.color,e);for(let e=0;e<t.text.length;e++)g.fillRect(t.x+6*e-6*t.text.length/2,t.y,5,8)}}function getMotivationalMessage(e){var t;return hs&&0!==hs?(t=hs-e)<0?"Â¡NUEVO RÃ‰CORD! ðŸ‘‘":t<100?"Â¡CASI RÃ‰CORD! ðŸ”¥":t<500?"Â¡MUY CERCA! ðŸ’ª":e>.8*hs?"Â¡SIGUE ASÃ! âš¡":e>.5*hs?"Â¡MITAD! ðŸŽ¯":"":""}function portalFeedback(t,a,i,n){for(let e=0;e<15;e++){var s=Math.random()*Math.PI*2,o=2*Math.random()+1;particles.push({x:t+n/2,y:a,vx:Math.cos(s)*o,vy:Math.sin(s)*o-2,size:Math.floor(3*Math.random()+2),life:.6*Math.random()+.4,col:i,isSquare:!0})}}function getPortalSize(e){var t;return e<30?PORTAL_W:e<60?Math.random()<.7?PORTAL_W:.8*PORTAL_W:e<90?(t=Math.random())<.4?PORTAL_W:t<.8?.7*PORTAL_W:MIN_PORTAL+20:e<150?(t=Math.random())<.2?.8*PORTAL_W:t<.7?MIN_PORTAL+30:MIN_PORTAL+10:Math.random()<.1?MIN_PORTAL+40:MIN_PORTAL+20*Math.random()}function getHelpMsg(e,t){return e<20?0===t?"Go through colored stripes!":"MATCH YOUR COLOR!":e<30?0===t?"Watch out! Portals can move!":"Moving portals incoming!":e<40?0===t?"Tiny portals appear!":"Small targets ahead!":e<50?0===t?"Some portals play tricks...":"Troll portals active!":0===t?"Chaos mode! Anything goes!":"SURVIVE THE MADNESS!"}function getMotivMsg(){var e=["GO!","YEAH!","NICE!","SWEET!","BOOM!"],t=["ON FIRE!ðŸ”¥","INSANE!","UNSTOPPABLE!","GODLIKE!","RAMPAGE!","LEGENDARY!","MONSTER!","DOMINATING!","PERFECTION!","FLAWLESS!"];return combo<=0?"":combo<=10?e[(combo-1)%e.length]:t[(combo-11)%t.length]}function loadData(){try{var e,t=localStorage.getItem("qd_data");t&&(e=JSON.parse(t),hs=e.hs||0,achv=e.achv||{},ranking=e.ranking||[],musicMuted=e.muted||0,console.log("Data loaded:",{hs:hs,rankingCount:ranking.length}))}catch(e){console.warn("Failed to load data:",e)}}function saveData(){try{localStorage.setItem("qd_data",JSON.stringify({hs:hs,achv:achv,ranking:ranking,muted:musicMuted})),console.log("Data saved:",{hs:hs,rankingCount:ranking.length})}catch(e){console.warn("Failed to save data:",e)}}function addToRanking(e,t,a,i,n){ranking.push({name:e,score:t,time:a,mode:MODE_NAMES[i],diff:DIFF_NAMES[n],date:Date.now()}),ranking.sort((e,t)=>t.score-e.score),15<ranking.length&&(ranking=ranking.slice(0,15)),saveData()}function playSound(e,t){if(snd&&"suspended"!==snd.state){var a=snd.createOscillator(),i=snd.createGain(),n=(a.connect(i),i.connect(snd.destination),1+.05*(t||0));if("portal"===e)a.frequency.value=700*n,i.gain.setValueAtTime(.15,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.1),a.start(),a.stop(snd.currentTime+.1);else if("death"===e){a.frequency.value=120,a.type="sawtooth",i.gain.setValueAtTime(.12,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.3),a.start(),a.stop(snd.currentTime+.3);var s=snd.createOscillator(),o=snd.createGain();s.connect(o),o.connect(snd.destination),s.frequency.value=60,s.type="square",o.gain.setValueAtTime(.08,snd.currentTime),o.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.4),s.start(),s.stop(snd.currentTime+.4)}else if("troll"===e)a.frequency.value=800,i.gain.setValueAtTime(.1,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.08),a.start(),a.stop(snd.currentTime+.08);else if("achievement"===e)for(let e=0;e<4;e++){var l=snd.createOscillator(),r=snd.createGain(),r=(l.connect(r),r.connect(snd.destination),l.frequency.value=[400,500,650,800][e],r.gain.setValueAtTime(.18,snd.currentTime+.15*e),r.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.15*e+.3),l.start(snd.currentTime+.15*e),l.stop(snd.currentTime+.15*e+.3),snd.createOscillator()),l=snd.createGain();r.connect(l),l.connect(snd.destination),r.frequency.value=.5*[400,500,650,800][e],l.gain.setValueAtTime(.08,snd.currentTime+.15*e+.15),l.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.15*e+.5),r.start(snd.currentTime+.15*e+.15),r.stop(snd.currentTime+.15*e+.5)}else"combo"===e?(a.frequency.value=900*n,a.type="triangle",i.gain.setValueAtTime(.1,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.15),a.start(),a.stop(snd.currentTime+.15),t&&5<t&&(o=snd.createOscillator(),s=snd.createGain(),o.connect(s),s.connect(snd.destination),o.frequency.value=900*n*1.5,o.type="triangle",s.gain.setValueAtTime(.05,snd.currentTime+.08),s.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.2),o.start(snd.currentTime+.08),o.stop(snd.currentTime+.2))):"move"===e?(a.frequency.value=400,a.type="sine",i.gain.setValueAtTime(.04,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.08),a.start(),a.stop(snd.currentTime+.08)):"change"===e?(a.frequency.value=550,a.type="triangle",i.gain.setValueAtTime(.05,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.1),a.start(),a.stop(snd.currentTime+.1)):"menu"===e?(a.frequency.value=600,a.type="square",i.gain.setValueAtTime(.03,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.12),a.start(),a.stop(snd.currentTime+.12)):"select"===e?(a.frequency.value=800,a.type="triangle",i.gain.setValueAtTime(.06,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.2),a.start(),a.stop(snd.currentTime+.2)):"countdown"===e?(a.frequency.value=440,a.type="square",i.gain.setValueAtTime(.05,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.15),a.start(),a.stop(snd.currentTime+.15)):"go"===e&&(a.frequency.value=880,a.type="sawtooth",i.gain.setValueAtTime(.08,snd.currentTime),i.gain.exponentialRampToValueAtTime(.01,snd.currentTime+.25),a.start(),a.stop(snd.currentTime+.25))}}function playMusic(e){var a,i,n,s,o,l,r,c;snd?musicMuted?console.log("Music muted"):"suspended"===snd.state?(console.log("Audio suspended, resuming... State:",snd.state),snd.resume().then(()=>{console.log("Audio resumed successfully! State:",snd.state)}).catch(e=>console.log("Audio resume failed:",e))):(Math.floor(e)%5==0&&e%1<.1&&console.log("ðŸŽµ Music playing - State:",snd.state,"Time:",e.toFixed(1),"Vol:",musicVol),musicVol=e<.3?Math.min(e/.3,1):1,a=.3*Math.min(combo/15,1),a=musicVol*(.8+a),l=1.2+.25*(mom-1)+(o=.2*Math.min(t/60,3)),n=Math.floor(t/30)%6,i=.12/l,0<musicTime&&e-musicTime<i||(musicTime=e,t<1&&Math.random()<.01&&console.log("Music playing, vol:",a,"tempo:",l),e=(i=Math.floor(4*e*l))%8,r=8<=i%16,n=[{bass:[65,82,55,73,65,82,98,73],melody:[262,330,392,330,262,392,440,330],kickEvery:2,snareEvery:4,hhEvery:2},{bass:[87,110,73,98,87,110,130,98],melody:[349,440,523,440,349,523,587,440],kickEvery:1,snareEvery:2,hhEvery:1},{bass:[110,87,130,98,110,147,98,130],melody:[523,440,659,523,587,440,698,523],kickEvery:1,snareEvery:2,hhEvery:.5},{bass:[130,98,147,110,130,165,110,147],melody:[659,523,784,659,698,523,880,659],kickEvery:.5,snareEvery:2,hhEvery:.5},{bass:[147,110,165,130,147,196,130,165],melody:[784,659,988,784,880,659,1047,784],kickEvery:.5,snareEvery:1.5,hhEvery:.25},{bass:[165,130,196,147,165,220,147,196],melody:[988,784,1175,988,1047,784,1319,988],kickEvery:.5,snareEvery:1,hhEvery:.25}][n],c=snd.createOscillator(),s=snd.createGain(),c.connect(s),s.connect(snd.destination),c.frequency.value=n.bass[e]*(1+.5*o),c.type="sawtooth",l=.11/l,s.gain.setValueAtTime(.05*a,snd.currentTime),s.gain.exponentialRampToValueAtTime(.001,snd.currentTime+l),c.start(),c.stop(snd.currentTime+l),i%2==0&&(s=snd.createOscillator(),c=snd.createGain(),s.connect(c),c.connect(snd.destination),s.frequency.value=.5*n.bass[e],s.type="sine",c.gain.setValueAtTime(.03*a,snd.currentTime),c.gain.exponentialRampToValueAtTime(.001,snd.currentTime+l),s.start(),s.stop(snd.currentTime+l)),c=snd.createOscillator(),s=snd.createGain(),c.connect(s),s.connect(snd.destination),c.frequency.value=n.melody[e]*(1+.3*o),c.type=r?"triangle":"square",s.gain.setValueAtTime((r?.08:.06)*a,snd.currentTime),s.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.7*l),c.start(snd.currentTime+.01),c.stop(snd.currentTime+.7*l),r&&i%4==0&&(o=snd.createOscillator(),s=snd.createGain(),o.connect(s),s.connect(snd.destination),o.frequency.value=2*n.melody[e],o.type="sine",s.gain.setValueAtTime(.02*a,snd.currentTime),s.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.5*l),o.start(snd.currentTime+.02),o.stop(snd.currentTime+.5*l)),i%(2*n.kickEvery)==0&&(c=snd.createOscillator(),r=snd.createGain(),c.connect(r),r.connect(snd.destination),c.frequency.setValueAtTime(120,snd.currentTime),c.frequency.exponentialRampToValueAtTime(40,snd.currentTime+.05),c.type="sine",r.gain.setValueAtTime(.08*a,snd.currentTime),r.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.05),c.start(),c.stop(snd.currentTime+.05)),i%(2*n.snareEvery)===n.snareEvery&&(e=snd.createOscillator(),s=snd.createGain(),e.connect(s),s.connect(snd.destination),e.frequency.value=200+50*Math.random(),e.type="triangle",s.gain.setValueAtTime(.03*a,snd.currentTime),s.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.06),e.start(),e.stop(snd.currentTime+.06)),i%(2*n.hhEvery)==0&&(o=snd.createOscillator(),l=snd.createGain(),o.connect(l),l.connect(snd.destination),o.frequency.value=8e3+2e3*Math.random(),o.type="square",l.gain.setValueAtTime(.01*a,snd.currentTime),l.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.02),o.start(),o.stop(snd.currentTime+.02)),Math.abs(t%30)<.2&&1<t&&(r=snd.createOscillator(),c=snd.createGain(),r.connect(c),c.connect(snd.destination),r.frequency.value=12e3+4e3*Math.random(),r.type="square",c.gain.setValueAtTime(.04*a,snd.currentTime),c.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.5),r.start(),r.stop(snd.currentTime+.5)))):console.log("No audio context")}function checkAchv(){!achv.survivor30&&30<=t&&(achv.survivor30=1,showAchv("30s Survivor!"),saveData()),!achv.survivor60&&60<=t&&(achv.survivor60=1,showAchv("60s Legend!"),saveData()),!achv.combo10&&10<=combo&&(achv.combo10=1,showAchv("x10 Combo Master!"),saveData()),!achv.chaos&&50<=t&&(achv.chaos=1,showAchv("Chaos Mode!"),saveData()),!achv.troll5&&5<=trollsDodged&&(achv.troll5=1,showAchv("Troll Dodger!"),saveData())}function showAchv(e){txts.achv.setText(e).setVisible(1),achvShow=3,playSound("achievement"),cam.flash(300,100,200,100)}function create(){this.g=this.add.graphics(),cam=this.cameras.main,g=this.g;try{if((snd=this.sound.context)&&"suspended"===snd.state){let e=()=>{snd&&"suspended"===snd.state&&snd.resume().then(()=>console.log("Audio resumed")),document.removeEventListener("keydown",e),document.removeEventListener("click",e)};document.addEventListener("keydown",e,{once:!0}),document.addEventListener("click",e,{once:!0})}}catch(e){console.warn("Audio context initialization failed:",e),snd=null}loadData(),txts.title=this.add.text(W/2,60,"QUANTUM DASH",{fontSize:"48px",color:"#0ff",fontFamily:"monospace",fontStyle:"bold"}).setOrigin(.5),txts.sub=this.add.text(W/2,105,"Portal Runner",{fontSize:"18px",color:"#fff",fontFamily:"monospace"}).setOrigin(.5),txts.modeLabel=this.add.text(W/2,170,"MODE",{fontSize:"16px",color:"#aaa",fontFamily:"monospace"}).setOrigin(.5),txts.modeVal=this.add.text(W/2,195,"",{fontSize:"22px",color:"#0ff",fontFamily:"monospace"}).setOrigin(.5),txts.diffLabel=this.add.text(W/2,235,"DIFFICULTY",{fontSize:"16px",color:"#aaa",fontFamily:"monospace"}).setOrigin(.5),txts.diffVal=this.add.text(W/2,260,"",{fontSize:"22px",color:"#f90",fontFamily:"monospace"}).setOrigin(.5),txts.playersLabel=this.add.text(W/2,300,"PLAYERS",{fontSize:"16px",color:"#aaa",fontFamily:"monospace"}).setOrigin(.5),txts.playersVal=this.add.text(W/2,325,"",{fontSize:"22px",color:"#0f0",fontFamily:"monospace"}).setOrigin(.5),txts.musicLabel=this.add.text(W/2,365,"MUSIC",{fontSize:"16px",color:"#aaa",fontFamily:"monospace"}).setOrigin(.5),txts.musicVal=this.add.text(W/2,390,"",{fontSize:"22px",color:"#ff0",fontFamily:"monospace"}).setOrigin(.5),txts.rankLabel=this.add.text(W/2,430,"",{fontSize:"20px",color:"#f0f",fontFamily:"monospace"}).setOrigin(.5),txts.menuInst=this.add.text(W/2,490,"â†‘â†“: Select | â†â†’: Change | START: Play",{fontSize:"14px",color:"#888",fontFamily:"monospace"}).setOrigin(.5),txts.ctrl=this.add.text(W/2,H-20,"P1: Stick + Btn | P2: Stick + Btn",{fontSize:"13px",color:"#888",fontFamily:"monospace"}).setOrigin(.5),txts.p1sc=this.add.text(20,20,"",{fontSize:"18px",color:"#0af",fontFamily:"monospace"}).setOrigin(0),txts.p2sc=this.add.text(W-150,20,"",{fontSize:"18px",color:"#f90",fontFamily:"monospace"}).setOrigin(0),txts.timer=this.add.text(W/2,20,"",{fontSize:"22px",color:"#fff",fontFamily:"monospace"}).setOrigin(.5),txts.help=this.add.text(W/2,50,"",{fontSize:"15px",color:"#ff0",fontFamily:"monospace"}).setOrigin(.5),txts.combo=this.add.text(W-20,50,"",{fontSize:"24px",color:"#f0f",fontFamily:"monospace"}).setOrigin(1,.5),txts.motiv=this.add.text(W/2,120,"",{fontSize:"42px",color:"#0ff",fontFamily:"monospace"}).setOrigin(.5),txts.lives=this.add.text(20,50,"",{fontSize:"16px",color:"#f55",fontFamily:"monospace"}).setOrigin(0),txts.momentum=this.add.text(W-20,H-30,"",{fontSize:"14px",color:"#0f0",fontFamily:"monospace"}).setOrigin(1),txts.menu=this.add.text(W/2,H-20,"T: Menu",{fontSize:"14px",color:"#888",fontFamily:"monospace"}).setOrigin(.5),txts.go=this.add.text(W/2,H/2-200,"GAME OVER",{fontSize:"48px",color:"#f55",fontFamily:"monospace"}).setOrigin(.5),txts.newrec=this.add.text(W/2,H/2-130,"NEW RECORD!",{fontSize:"38px",color:"#ff0",fontFamily:"monospace"}).setOrigin(.5),txts.win=this.add.text(W/2,H/2-150,"",{fontSize:"36px",color:"#0f0",fontFamily:"monospace"}).setOrigin(.5),txts.p1end=this.add.text(W/2,H/2+35,"",{fontSize:"22px",color:"#0af",fontFamily:"monospace"}).setOrigin(.5),txts.p2end=this.add.text(W/2,H/2+65,"",{fontSize:"22px",color:"#f90",fontFamily:"monospace"}).setOrigin(.5),txts.restart=this.add.text(W/2,H/2+110,"SPACE: Back to Menu",{fontSize:"20px",color:"#fff",fontFamily:"monospace"}).setOrigin(.5),txts.countdown=this.add.text(W/2,H/2,"",{fontSize:"80px",color:"#0ff",fontFamily:"monospace",fontStyle:"bold"}).setOrigin(.5),txts.achv=this.add.text(W/2,H-80,"",{fontSize:"24px",color:"#ff0",fontFamily:"monospace"}).setOrigin(.5),txts.rankView=this.add.text(W/2,H/2,"",{fontSize:"14px",color:"#fff",fontFamily:"monospace",align:"center"}).setOrigin(.5),txts.namePrompt=this.add.text(W/2,120,"NEW HIGH SCORE! Enter your name (3 chars):",{fontSize:"20px",color:"#ff0",fontFamily:"monospace"}).setOrigin(.5),txts.nameInput=this.add.text(W/2,200,"",{fontSize:"40px",color:"#0ff",fontFamily:"monospace"}).setOrigin(.5),txts.nameLetters=this.add.text(W/2,320,"",{fontSize:"20px",color:"#fff",fontFamily:"monospace"}).setOrigin(.5),txts.nameHint=this.add.text(W/2,520,"WASD: Move | SPACE: Select | ENTER: Accept",{fontSize:"14px",color:"#888",fontFamily:"monospace"}).setOrigin(.5),txts.nameAccept=this.add.text(W/2,450,"[ACCEPT]",{fontSize:"18px",color:"#0f0",fontFamily:"monospace"}).setOrigin(.5),txts.matchStats=this.add.text(W/2,H/2+20,"",{fontSize:"16px",color:"#aaa",fontFamily:"monospace",align:"center"}).setOrigin(.5),this.input.keyboard.on("keydown-W",()=>{0!==sc||txts.rankView.visible||(menuSel=(menuSel-1+5)%5,updateMenuHighlight(),playSound("move"))}),this.input.keyboard.on("keydown-S",()=>{0!==sc||txts.rankView.visible||(menuSel=(menuSel+1)%5,updateMenuHighlight(),playSound("move"))}),this.input.keyboard.on("keydown-A",()=>{0!==sc||txts.rankView.visible||(0===menuSel?gm=(gm-1+3)%3:1===menuSel?diff=(diff-1+4)%4:2===menuSel?m=1-m:3===menuSel&&(musicMuted=1-musicMuted,saveData()),updateMenuHighlight(),playSound("change"))}),this.input.keyboard.on("keydown-D",()=>{0!==sc||txts.rankView.visible||(0===menuSel?gm=(gm+1)%3:1===menuSel?diff=(diff+1)%4:2===menuSel?m=1-m:3===menuSel&&(musicMuted=1-musicMuted,saveData()),updateMenuHighlight(),playSound("change"))}),this.input.keyboard.on("keydown-SPACE",()=>{txts.rankView.visible?(toggleRanking(),playSound("menu")):0!==sc||txts.namePrompt.visible?2===sc&&(txts.rankView.visible?(txts.rankView.setVisible(0),sc=0,walls=[],t=0,spd=2,baseSpeed=3.5,nextId=0,combo=0,lives1=3,lives2=3,cam.resetFX(),playSound("menu"),showMenu()):(txts.restart.visible||txts.win.visible)&&(sc=0,walls=[],t=0,spd=2,baseSpeed=3.5,nextId=0,combo=0,lives1=3,lives2=3,cam.resetFX(),playSound("menu"),showMenu())):(4===menuSel?toggleRanking():start(this,m),playSound("select"))}),this.input.keyboard.on("keydown-ENTER",()=>{txts.rankView.visible?(toggleRanking(),playSound("menu")):0!==sc||txts.namePrompt.visible?2===sc&&(txts.rankView.visible?(txts.rankView.setVisible(0),sc=0,walls=[],t=0,spd=2,baseSpeed=3.5,nextId=0,combo=0,lives1=3,lives2=3,cam.resetFX(),playSound("menu"),showMenu()):(txts.restart.visible||txts.win.visible)&&(sc=0,walls=[],t=0,spd=2,baseSpeed=3.5,nextId=0,combo=0,lives1=3,lives2=3,cam.resetFX(),playSound("menu"),showMenu())):(4===menuSel?toggleRanking():start(this,m),playSound("select"))}),this.input.keyboard.on("keydown-LEFT",()=>{}),this.input.keyboard.on("keydown-RIGHT",()=>{}),this.input.keyboard.on("keydown",e=>{var a;1===sc&&"t"===e.key.toLowerCase()&&(sc=0,walls=[],t=0,spd=2,baseSpeed=3.5,nextId=0,combo=0,lives1=3,lives2=3,showMenu()),3===sc&&txts.namePrompt.visible&&("a"===(a=e.key.toLowerCase())||"d"===a||"w"===a||"s"===a?lastKeyDir!==a&&(lastKeyDir=a,keyHoldTime=0,"a"===a?--nameCol<0&&(nameCol=ALPHABET_GRID[nameRow].length-1):"d"===a?++nameCol>=ALPHABET_GRID[nameRow].length&&(nameCol=0):"w"===a?onAcceptButton?(onAcceptButton=0,nameRow=ALPHABET_GRID.length-1):(--nameRow<0&&(nameRow=ALPHABET_GRID.length-1),nameCol>=ALPHABET_GRID[nameRow].length&&(nameCol=ALPHABET_GRID[nameRow].length-1)):"s"!==a||onAcceptButton||(++nameRow>=ALPHABET_GRID.length?nameRow=3===nameInput.length?(onAcceptButton=1,ALPHABET_GRID.length-1):0:nameCol>=ALPHABET_GRID[nameRow].length&&(nameCol=ALPHABET_GRID[nameRow].length-1)),playSound("move"),updateNameInput()):" "===e.key?onAcceptButton&&3===nameInput.length?(a=Math.floor(p1.sc*mom),addToRanking(nameInput,a,t,gm,diff),particles=[],sc=0,nameInput="",nameRow=0,nameCol=0,onAcceptButton=0,playSound("select"),showMenu()):onAcceptButton||("<"===(a=ALPHABET_GRID[nameRow][nameCol])?0<nameInput.length&&(nameInput=nameInput.slice(0,-1),onAcceptButton=0):" "!==a&&nameInput.length<3&&3===(nameInput+=a).length&&(onAcceptButton=1),playSound("select"),updateNameInput()):"Enter"===e.key&&3===nameInput.length&&(a=Math.floor(p1.sc*mom),addToRanking(nameInput,a,t,gm,diff),particles=[],sc=0,nameInput="",nameRow=0,nameCol=0,onAcceptButton=0,playSound("select"),showMenu()))}),this.input.keyboard.on("keyup",e=>{e=e.key.toLowerCase();3!==sc||"a"!==e&&"d"!==e&&"w"!==e&&"s"!==e||lastKeyDir===e&&(lastKeyDir="",keyHoldTime=0)}),showMenu()}function toggleRanking(){if(txts.rankView.visible)txts.rankView.setVisible(0),showMenu();else{hideAll();let t="=== TOP 15 RANKING ===\n\n";if(0===ranking.length)t+="No records yet!\n\nPlay to set a record!";else for(let e=0;e<ranking.length;e++){var a=ranking[e];t+=`${e+1}. ${a.name} - ${a.score}pts\n   ${a.mode} | ${a.diff} | ${a.time.toFixed(1)}s\n\n`}t+="\nSPACE: Back to Menu",txts.rankView.setText(t).setVisible(1)}}function updateMenuHighlight(){txts.modeVal.setColor(0===menuSel?"#0ff":"#666").setText("< "+MODE_NAMES[gm]+" >"),txts.diffVal.setColor(1===menuSel?"#f90":"#666").setText("< "+DIFF_NAMES[diff]+" >"),txts.playersVal.setColor(2===menuSel?"#0f0":"#666").setText("< "+(0===m?"1 PLAYER":"2 PLAYERS")+" >"),txts.musicVal.setColor(3===menuSel?"#ff0":"#666").setText("< "+(musicMuted?"OFF":"ON")+" >"),txts.rankLabel.setColor(4===menuSel?"#f0f":"#666").setText(4===menuSel?"> VIEW RANKING <":"VIEW RANKING")}function spawnParticles(t,a){for(let e=0;e<a;e++)particles.push({x:Math.random()*W,y:Math.random()*H,vx:.5*(Math.random()-.5),vy:.5*(Math.random()-.5),size:Math.floor(3*Math.random()+2),life:.5*Math.random()+.3,col:t,isSquare:!0})}function updateParticles(t){for(let e=particles.length-1;0<=e;e--){var a=particles[e];a.x+=a.vx*t*.05,a.y+=a.vy*t*.05,a.life-=3e-4*t,a.x<0&&(a.x=W),a.x>W&&(a.x=0),a.y<0&&(a.y=H),a.y>H&&(a.y=0),a.life<=0&&particles.splice(e,1)}}function drawParticles(){for(var e of particles)g.fillStyle(e.col,.4*e.life),e.isSquare?g.fillRect(e.x-e.size/2,e.y-e.size/2,e.size,e.size):g.fillCircle(e.x,e.y,e.size)}function updateNameInput(){let t="";for(let e=0;e<3;e++)e<nameInput.length?t+=nameInput[e]:t+="_",e<2&&(t+=" ");txts.nameInput.setText(t);let i="";for(let a=0;a<ALPHABET_GRID.length;a++){var n=ALPHABET_GRID[a];for(let t=0;t<n.length;t++){let e=n[t];"<"===e&&(e="DEL"),a===nameRow&&t===nameCol?i+=`[${e}]`:i+=` ${e} `,t<n.length-1&&(i+=" ")}a<ALPHABET_GRID.length-1&&(i+="\n")}txts.nameLetters.setText(i),3===nameInput.length?(onAcceptButton?txts.nameAccept.setText("> [ACCEPT] <"):txts.nameAccept.setText("[ACCEPT]")).setVisible(1):(txts.nameAccept.setVisible(0),onAcceptButton=0)}function activatePowerup(e,t){playSound("combo"),"slowmo"===e?activePowers.slowmo=5:"shield"===e?1===t?activePowers.shield1=8:activePowers.shield2=8:"star"===e?(activePowers.star=6,1===t?invincible1=6:invincible2=6):"vision"===e?activePowers.vision=10:"speed"===e?activePowers.speed=5:"heart"===e&&(1===t&&lives1<3?(lives1++,playSound("achievement")):2===t&&lives2<3&&(lives2++,playSound("achievement")))}function playMenuMusic(e){var t,a,i;!snd||musicMuted||"suspended"===snd.state||e-musicTime<.25||(musicTime=e,t=[65,82,98,73,87,110],e=Math.floor(4*e)%t.length,a=snd.createOscillator(),i=snd.createGain(),a.connect(i),i.connect(snd.destination),a.frequency.value=t[e],a.type="sawtooth",i.gain.setValueAtTime(.045,snd.currentTime),i.gain.exponentialRampToValueAtTime(.001,snd.currentTime+.23),a.start(),a.stop(snd.currentTime+.23))}function start(e,a){m=a,sc=1,t=0,spd=2,baseSpeed=3.5,walls=[],nextId=0,combo=0,portals=0,mom=1,deathSlowdown=0,trollsDodged=0,invincible1=0,invincible2=0,maxCombo=0,comboAnim=0,musicVol=0,timeLimit=1===gm?180:0,lives1=2===gm?1:3,lives2=2===gm?1:3,trail1=[],trail2=[],powerups=[],bugs=[],activePowers={slowmo:0,shield1:0,shield2:0,star:0,vision:0,speed:0},bossWave=0,rouletteTime=0,lastRouletteT=0,musicTime=0,spin1Angle=0,spin2Angle=0,spin1Center={x:W/2,y:H/2},spin2Center={x:W/2,y:H/2},spin1Particles=[],spin2Particles=[];var a=1===m?W/3:W/2,i=2*W/3;p1={x:a,vx:0,y:H-80,vy:0,path:[],alive:1,sc:0},p2=1===m?{x:i,vx:0,y:H-80,vy:0,path:[],alive:1,sc:0}:null,hideAll(),cam.resetFX(),txts.countdown.setVisible(1).setText("3"),countdown=2.2,playSound("countdown")}function update(e,a){if(0===sc)particles.length<100&&Math.random()<.3&&spawnParticles(P1_COLOR,2),updateParticles(a),g.clear(),txts.rankView.visible&&(g.fillStyle(0,1),g.fillRect(0,0,W,H)),drawParticles(),playMenuMusic(.001*Date.now());else if(2===sc)particles.length<150&&Math.random()<.4&&spawnParticles(16729156,3),updateParticles(a),g.clear(),drawParticles();else if(3===sc)particles.length<150&&Math.random()<.4&&spawnParticles(16729156,3),updateParticles(a),""!==lastKeyDir&&300<(keyHoldTime+=a)&&keyHoldTime%80<a&&("a"===lastKeyDir?--nameCol<0&&(nameCol=ALPHABET_GRID[nameRow].length-1):"d"===lastKeyDir?++nameCol>=ALPHABET_GRID[nameRow].length&&(nameCol=0):"w"===lastKeyDir?(--nameRow<0&&(nameRow=ALPHABET_GRID.length-1),nameCol>=ALPHABET_GRID[nameRow].length&&(nameCol=ALPHABET_GRID[nameRow].length-1)):"s"===lastKeyDir&&(++nameRow>=ALPHABET_GRID.length&&(nameRow=0),nameCol>=ALPHABET_GRID[nameRow].length)&&(nameCol=ALPHABET_GRID[nameRow].length-1),playSound("move"),updateNameInput()),g.clear(),g.fillStyle(0,.85),g.fillRect(0,0,W,H),drawParticles();else{if(0<countdown){if(1.6<countdown?txts.countdown.setText("3"):1<countdown?"2"!==txts.countdown.text&&(txts.countdown.setText("2"),playSound("countdown")):.4<countdown?"1"!==txts.countdown.text&&(txts.countdown.setText("1"),playSound("countdown")):"GO!"!==txts.countdown.text&&(txts.countdown.setText("GO!"),playSound("go")),g.clear(),p1&&(n=P1_COLOR,g.fillStyle(n,1),g.fillRect(p1.x-4,p1.y-4,8,8)),p2&&(n=P2_COLOR,g.fillStyle(n,1),g.fillRect(p2.x-4,p2.y-4,8,8)),!((countdown-=.001*a)<=0))return;txts.countdown.setVisible(0),countdown=-1,showGame(),spawnWall()}t+=.001*a;var n=DIFF_MULTS[diff],i=(0<invincible1&&(invincible1-=.001*a)<0&&(invincible1=0),0<invincible2&&(invincible2-=.001*a)<0&&(invincible2=0),1-.5*(deathSlowdown=0<deathSlowdown&&(deathSlowdown-=5e-4*a)<0?0:deathSlowdown)),s=0<activePowers.slowmo?.6:1,o=(baseSpeed=t<=30?(spd=2,3.5):t<=90?(r=(t-30)/60,spd=2+1.5*r,3.5+1.5*r):t<=180?(r=(t-90)/90,spd=3.5+3*r,5+3*r):(spd=6.5,8),spd*i*n*s),l=baseSpeed*i*n*s,r=(mom=1+Math.min(.01*t,2),50<t&&Math.random()<.1&&cam.shake(50,.01*(t-50)*.002),60<t?1.4:1),n=45*(l+o)*r,s=4*n,r=n+Math.random()*(s-n);if((0===walls.length||walls[walls.length-1].y>r)&&spawnWall(),20<t&&Math.random()<.06*a*.001){s=POWERUP_TYPES[Math.floor(Math.random()*POWERUP_TYPES.length)],n=Math.random();let e,t,a,i;i=n<.3?(e=80+Math.random()*(W-160),t=-20,a=2*(Math.random()-.5),0):(a=n<.6?(e=-20,t=60+Math.random()*(H-100),1.5*Math.random()+.5):(e=W+20,t=60+Math.random()*(H-100),-(1.5*Math.random()+.5)),Math.random()-.5),powerups.push({x:e,y:t,vx:a,vy:i,type:s,size:12})}if(30<t&&Math.random()<.008*a*.001*DIFF_MULTS[diff]){r=80+Math.random()*(W-160);let e=0;Math.random()<.5&&(e=(2*Math.random()+1)*(Math.random()<.5?1:-1)),bugs.push({x:r,y:-20,vx:e,size:8,health:1})}45<t&&15<t-lastRouletteT&&Math.random()<.002*a*.001*DIFF_MULTS[diff]&&(lastRouletteT=t,rouletteTime=3,playSound("troll"),cam.shake(100,.005)),0<rouletteTime&&(rouletteTime-=.001*a)<0&&(rouletteTime=0);n=Math.floor(t/60);0<n&&bossWave<n&&(bossWave=n,txts.motiv.setText("BOSS WAVE!").setColor("#ff0").setScale(.8).setAlpha(1).setVisible(1),motivShow=.15,playSound("achievement"),cam.shake(200,.008)),60<t&&Math.random()<.008*a*.001&&(s=80+Math.random()*(W-160),bugs.push({x:s,y:-20,vx:(2*Math.random()+1)*(Math.random()<.5?1:-1),size:10,health:2}));for(let e=walls.length-1;0<=e;e--){walls[e].y+=o;var c,d,p,h,u,x,f,v=walls[e];for(c of v.portals)c.vx&&(c.x+=c.vx*i,c.x<50||c.x>W-c.w-50)&&(c.vx*=-1),c.troll&&!c.trollActive&&(d=Math.abs(v.y-p1.y),p=Math.abs(c.x+c.w/2-p1.x),d<TROLL_DIST)&&p<80&&(c.trollActive=1,d=p1.x<c.x?1:-1,p=80+60*Math.random(),p=c.x+d*p,c.targetX=Math.max(60,Math.min(W-c.w-60,p)),c.vx=d*l*1.5,playSound("troll"),trollsDodged++),c.trollActive&&c.targetX&&(0<c.vx&&c.x>=c.targetX||c.vx<0&&c.x<=c.targetX)&&(c.x=c.targetX,c.vx=0,c.targetX=null);1!==m||2!==v.portals.length||v.portals[0].unified||(h=v.portals[0],u=v.portals[1],0<(x=Math.max(0,Math.min(h.x+h.w,u.x+u.w)-Math.max(h.x,u.x)))?Math.random()<.5?h.vx&&u.vx&&(h.vx*=-1,u.vx*=-1):.3<(f=Math.min(x/h.w,1))&&(h.col=blendColor(P1_COLOR,UNIFIED_COLOR,f),u.col=blendColor(P2_COLOR,UNIFIED_COLOR,f)):0===x&&(h.col!==P1_COLOR&&(h.col=P1_COLOR),u.col!==P2_COLOR)&&(u.col=P2_COLOR)),v.y>H+50&&walls.splice(e,1)}r=this.input.keyboard,n=0<activePowers.speed?1.5:1;p1&&p1.alive&&(r.addKey("A").isDown?p1.vx=-l*n:r.addKey("D").isDown?p1.vx=l*n:p1.vx=0,r.addKey("W").isDown?p1.vy=-l*n:r.addKey("S").isDown?p1.vy=l*n:p1.vy=0),p2&&p2.alive&&(r.addKey("LEFT").isDown?p2.vx=-l*n:r.addKey("RIGHT").isDown?p2.vx=l*n:p2.vx=0,r.addKey("UP").isDown?p2.vy=-l*n:r.addKey("DOWN").isDown?p2.vy=l*n:p2.vy=0);for(let e=bugs.length-1;0<=e;e--){var y=bugs[e];if(y.y+=.7*o,y.x+=y.vx,(y.x<40||y.x>W-40)&&(y.vx*=-1),p1&&p1.alive)if(Math.sqrt((p1.x-y.x)**2+(p1.y-y.y)**2)<y.size+10){if(0<invincible1||0<activePowers.star){bugs.splice(e,1),playSound("troll"),p1.sc+=50;continue}p1.alive=0,combo=0,cam.shake(300,.012),playSound("death"),bugs.splice(e,1);continue}if(p2&&p2.alive)if(Math.sqrt((p2.x-y.x)**2+(p2.y-y.y)**2)<y.size+10){if(0<invincible2||0<activePowers.star){bugs.splice(e,1),playSound("troll"),p2.sc+=50;continue}p2.alive=0,combo=0,cam.shake(300,.012),playSound("death"),bugs.splice(e,1);continue}y.y>H+30&&bugs.splice(e,1)}for(let e=powerups.length-1;0<=e;e--){var T,w=powerups[e];w.y+=(w.vy||0)+.6*o,w.x+=w.vx||0,w.x<20?(w.x=20,w.vx=Math.abs(w.vx||0)):w.x>W-20&&(w.x=W-20,w.vx=-Math.abs(w.vx||0));let t=!0;for(T of walls)if(Math.abs(T.y-w.y)<30){let e=!1;for(var M of T.portals)if(w.x>M.x-20&&w.x<M.x+M.w+20){e=!0;break}if(!e){t=!1;break}}if(t){if(p1&&p1.alive)if(Math.sqrt((p1.x-w.x)**2+(p1.y-w.y)**2)<w.size+15){activatePowerup(w.type,1),powerups.splice(e,1);continue}if(p2&&p2.alive)if(Math.sqrt((p2.x-w.x)**2+(p2.y-w.y)**2)<w.size+15){activatePowerup(w.type,2),powerups.splice(e,1);continue}}(w.y>H+50||w.x<-50||w.x>W+50)&&powerups.splice(e,1)}0<activePowers.slowmo&&(activePowers.slowmo-=.001*a,activePowers.slowmo<0)&&(activePowers.slowmo=0),0<activePowers.shield1&&(activePowers.shield1-=.001*a,activePowers.shield1<0)&&(activePowers.shield1=0),0<activePowers.shield2&&(activePowers.shield2-=.001*a,activePowers.shield2<0)&&(activePowers.shield2=0),0<activePowers.star&&(activePowers.star-=.001*a,activePowers.star<0)&&(activePowers.star=0),0<activePowers.vision&&(activePowers.vision-=.001*a,activePowers.vision<0)&&(activePowers.vision=0),0<activePowers.speed&&(activePowers.speed-=.001*a,activePowers.speed<0)&&(activePowers.speed=0),updateFloatingTexts(a);for(let e=spin1Particles.length-1;0<=e;e--){var S=spin1Particles[e];S.x+=S.vx,S.y+=S.vy,S.life-=.002*a,S.life<=0&&spin1Particles.splice(e,1)}for(let e=spin2Particles.length-1;0<=e;e--){var A=spin2Particles[e];A.x+=A.vx,A.y+=A.vy,A.life-=.002*a,A.life<=0&&spin2Particles.splice(e,1)}upd(p1,1),p2&&upd(p2,2),1===m&&p1.alive&&p2.alive&&Math.abs(p1.x-p2.x)<STICK_W+4&&(p1.x<p2.x?(p1.x-=3.5,p2.x+=3.5):(p1.x+=3.5,p2.x-=3.5)),0!==m||p1.alive||0!==invincible1||(0<--lives1?(p1.alive=1,p1.x=W/2,p1.y=H-80,p1.vx=0,p1.vy=0,combo=0,deathSlowdown=1,invincible1=1,cam.shake(200,.02),playSound("death")):(sc=2,showEnd())),1===m&&(!p1.alive&&0===invincible1&&0<lives1&&0<--lives1&&(p1.alive=1,p1.x=W/3,p1.y=H-80,p1.vx=0,p1.vy=0,combo=0,deathSlowdown=1,invincible1=1,cam.shake(200,.02),playSound("death")),!p2.alive&&0===invincible2&&0<lives2&&0<--lives2&&(p2.alive=1,p2.x=2*W/3,p2.y=H-80,p2.vx=0,p2.vy=0,combo=0,deathSlowdown=1,invincible2=1,cam.shake(200,.02),playSound("death")),lives1<=0&&!p1.alive||lives2<=0&&!p2.alive)&&(sc=2,showEnd()),checkAchv(),playMusic(t),draw();var s=50<t?1+.08*Math.sin(.008*Date.now()):1;if(txts.help.setText(getHelpMsg(t,m)).setScale(s),0<combo&&combo!==lastComboMsg&&motivShow<=0&&(r=getMotivMsg())&&(txts.motiv.setText(r).setAlpha(1).setVisible(1),motivShow=.15,txts.motiv.setScale(.8),lastComboMsg=combo),0===combo&&(lastComboMsg=0),0<motivShow&&(s=.8+5*(n=1-(motivShow-=.001*a)/.15),txts.motiv.setScale(s),.5<n?(r=1-2*(n-.5),txts.motiv.setAlpha(r)):txts.motiv.setAlpha(1),motivShow<=0)&&txts.motiv.setVisible(0),0<achvShow&&(achvShow-=.001*a)<=0&&txts.achv.setVisible(0),1===gm&&0<timeLimit){s=timeLimit-t;if(s<=0)return sc=2,void showEnd();var n=Math.floor(s/60),r=Math.floor(s%60);txts.timer.setText(`Time: ${n}:`+r.toString().padStart(2,"0")),s<30?(txts.timer.setColor("#f00"),n=1+.15*Math.sin(.015*Date.now()),txts.timer.setScale(n)):s<60?(txts.timer.setColor("#ff0"),r=1+.08*Math.sin(.01*Date.now()),txts.timer.setScale(r)):(txts.timer.setColor("#fff"),txts.timer.setScale(1))}else txts.timer.setText(`Time: ${t.toFixed(1)}s`),txts.timer.setColor("#fff"),txts.timer.setScale(1);txts.combo.setScale(1).setAlpha(1),0===m?(n=Math.floor(p1.sc*mom),txts.p1sc.setText("Score: "+n),txts.p1sc.setScale(1),txts.combo.setText(0<combo?"x"+combo:""),txts.lives.setText("Lives: "+"â¤".repeat(lives1)),s=2<mom?1+.1*Math.sin(.01*Date.now()):1,txts.momentum.setText("x"+mom.toFixed(1)).setScale(s)):(txts.p1sc.setText(`P1: ${p1.alive?"ALIVE":"DEAD"} â¤x`+lives1),txts.p2sc.setText(`P2: ${p2.alive?"ALIVE":"DEAD"} â¤x`+lives2),txts.combo.setText(0<combo?"x"+combo:""))}}function spawnWall(){let n=getPortalSize(t);40<t&&n===PORTAL_W&&(e=Math.min(.6*(t-40),PORTAL_W-20),n=Math.max(20,PORTAL_W-e));var e=20<t?Math.min(.15+.005*(t-20),.4)*DIFF_MULTS[diff]:0,s=Math.random()<e?(1.2*Math.random()+.4)*(Math.random()<.5?1:-1):0,o=40<t&&n===PORTAL_W&&Math.random()<TROLL_PROB*DIFF_MULTS[diff],e=35<t?Math.min(.08+.003*(t-35),.2)*DIFF_MULTS[diff]:0,e=Math.random()<e,l=0<walls.length?walls[walls.length-1]:null;let r=W/2;if(l&&0<l.portals.length&&0<(l=l.portals.filter(e=>!e.death)).length&&(l=l.reduce((e,t)=>e+t.x+t.w/2,0)/l.length,r=l),0===m){var i=W-n-60,l=0<walls.length?walls.find(e=>e.safe):null,c=l?l.col:colors[Math.floor(Math.random()*colors.length)],l=25<t?.2*DIFF_MULTS[diff]:0,d=Math.random()<l?Math.random()<.7?2:3:1,p=[],h=[],l=W-120,u=l/4,x=l;for(let a=0;a<d;a++){let t,e=0;do{var f=u+Math.random()*(x-u),v=Math.random()<.5?1:-1,v=r+v*f;t=Math.max(60,Math.min(i,v)),e++}while(h.some(e=>Math.abs(e-t)<n+30)&&e<20);e<20&&(h.push(t),p.push({x:t,w:n,col:c,forP1:1,forP2:0,vx:s,troll:o&&0===a,trollActive:0}))}if(e){let t,e=0;for(;t=60+Math.random()*(i-60),e++,h.some(e=>Math.abs(e-t)<n+40)&&e<10;);e<10&&p.push({x:t,w:.8*n,col:DEATH_PORTAL_COLOR,forP1:0,forP2:0,vx:.8*s,death:1})}walls.push({y:-50,portals:p,id:nextId,p1hit:0,p2hit:0})}else{var g=W-n-80,l=Math.random();let t,a;var y=W-120,T=y/4,w=y;if(l<.3){var y=T+Math.random()*(w-T),M=Math.random()<.5?1:-1;t=Math.max(80,Math.min(g,r+M*y)),a=t}else if(l<.6){M=T+Math.random()*(w-T),y=Math.random()<.5?1:-1,l=(t=Math.max(80,Math.min(g,r+y*M)),(40*Math.random()+10)*(Math.random()<.5?1:-1));a=Math.max(80,Math.min(g,t+l))}else{let e=0;do{var S=T+Math.random()*(w-T),A=Math.random()<.5?1:-1,A=(t=Math.max(80,Math.min(g,r+A*S)),T+Math.random()*(w-T)),S=Math.random()<.5?1:-1;a=Math.max(80,Math.min(g,r+S*A)),e++}while(Math.abs(t-a)<n+60&&e<20)}let i=[];if(i=t===a?[{x:t,w:n,col:UNIFIED_COLOR,forP1:1,forP2:1,vx:s,unified:1,troll:o,trollActive:0}]:[{x:t,w:n,col:P1_COLOR,forP1:1,forP2:0,vx:s,unified:0,troll:o,trollActive:0},{x:a,w:n,col:P2_COLOR,forP1:0,forP2:1,vx:s,unified:0,troll:o,trollActive:0}],e){var b,P=80+Math.random()*(g-80);let e=1;for(b of i)Math.abs(P-b.x)<n+40&&(e=0);e&&i.push({x:P,w:.8*n,col:DEATH_PORTAL_COLOR,forP1:0,forP2:0,vx:.8*s,death:1})}walls.push({y:-50,portals:i,id:nextId,p1hit:0,p2hit:0})}nextId++}function upd(i,n){if(i&&i.alive){i.x+=i.vx,i.y+=i.vy;var t=1===n?{angle:spin1Angle,center:spin1Center,particles:spin1Particles}:{angle:spin2Angle,center:spin2Center,particles:spin2Particles};if(1<Math.abs(i.vx)+Math.abs(i.vy)){var a=Math.atan2(i.vy,i.vx);let e=a-t.angle;if(e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI),t.angle=a,t.center.rotation=(t.center.rotation||0)+e,Math.abs(t.center.rotation)>=2*Math.PI){i.sc+=500,playSound("achievement"),showFloatingText("+500 SPIN!",i.x,i.y,16776960);for(let e=0;e<12;e++){var s=e*Math.PI*2/12;t.particles.push({x:i.x+20*Math.cos(s),y:i.y+20*Math.sin(s),vx:2*Math.cos(s),vy:2*Math.sin(s),life:1,col:1===n?P1_COLOR:P2_COLOR})}t.center.rotation=0}t.center.x=i.x,t.center.y=i.y}1===n?(spin1Angle=t.angle,spin1Center=t.center):(spin2Angle=t.angle,spin2Center=t.center);var o,a=Math.min(i.x-10,W-10-i.x,i.y-60,H-40-i.y),l=(a<15&&0<a&&2<Math.abs(i.vx)+Math.abs(i.vy)&&(!i.nearMissTime||500<Date.now()-i.nearMissTime)&&(i.sc+=25,i.nearMissTime=Date.now(),nearMiss++),i.x<10&&(i.x=10),i.x>W-10&&(i.x=W-10),i.y<60&&(i.y=60),i.y>H-40&&(i.y=H-40),1===n?0<invincible1:0<invincible2);for(o of walls){var r,e=1===n?o.p1hit:o.p2hit;if(!e&&Math.abs(o.y-i.y)<8){let e=0,t=null,a=0;for(var c of o.portals)if(i.x>c.x&&i.x<c.x+c.w){if(a=1,(t=c).death){e=0,t.isDeath=1;break}if(1===n&&c.forP1||2===n&&c.forP2){e=1;break}}if(!a)for(var d of o.portals)d.death||(r=Math.min(Math.abs(i.x-d.x),Math.abs(i.x-(d.x+d.w))),(1===n&&!d.forP1||2===n&&!d.forP2)&&r<20&&5<r&&(o.nearMissAwarded||(i.sc+=50,nearMiss++,o.nearMissAwarded=1,showFloatingText("+50 NEAR MISS!",i.x,i.y,16776960))));l?1===n?o.p1hit=1:o.p2hit=1:e?(1===n?o.p1hit=1:o.p2hit=1,20<++combo&&(combo=20),portals++,combo>maxCombo&&(maxCombo=combo),h=Math.min(combo,20),i.sc+=100*h*mom,playSound("portal",combo),portalFeedback(t.x,o.y,t.col,t.w),h=.002+8e-4*combo,p=30+3*combo,cam.shake(p,h)):a?1===n?o.p1hit=1:o.p2hit=1:(1===n?o.p1hit=1:o.p2hit=1,(1===n?0<activePowers.shield1:0<activePowers.shield2)?(1===n?activePowers.shield1=0:activePowers.shield2=0,cam.shake(200,.01),playSound("troll")):(i.alive=0,combo=0,cam.shake(400,.015),playSound("death")))}var p=o.y>H-60,h=o.y<i.y&&o.y>i.y-40&&!e;if((p||h)&&!l)if(0===m){if(!o.p1hit&&p1&&p1.alive)if(h){let e=!1;for(var u of o.portals)if(i.x>u.x&&i.x<u.x+u.w&&(1===n&&u.forP1||2===n&&u.forP2)){e=!0;break}e||(p1.alive=0,combo=0,cam.shake(400,.015),playSound("death"))}else p1.alive=0,combo=0,cam.shake(400,.015),playSound("death")}else{if(!o.p1hit&&p1&&p1.alive)if(h&&1===n){let e=!1;for(var x of o.portals)if(i.x>x.x&&i.x<x.x+x.w&&x.forP1){e=!0;break}e||(p1.alive=0,combo=0,cam.shake(400,.015),playSound("death"))}else p&&(p1.alive=0,combo=0,cam.shake(400,.015),playSound("death"));if(!o.p2hit&&p2&&p2.alive)if(h&&2===n){let e=!1;for(var f of o.portals)if(i.x>f.x&&i.x<f.x+f.w&&f.forP2){e=!0;break}e||(p2.alive=0,combo=0,cam.shake(400,.015),playSound("death"))}else p&&(p2.alive=0,combo=0,cam.shake(400,.015),playSound("death"))}}}}function draw(){var a,e,t,i,n;g.clear(),0<rouletteTime&&(P=.1*Math.sin(.02*Date.now())+.1,g.fillStyle(16711935,P),g.fillRect(0,0,W,H)),0<activePowers.slowmo&&(g.fillStyle(65535,.08),g.fillRect(0,0,W,H));for(a of walls){var s=6710886,o=[...a.portals].sort((e,t)=>e.x-t.x);if(o[0].w>=MAX_PORTAL)g.fillStyle(o[0].col),g.fillRect(60,a.y-WALL_THICK/2,W-120,WALL_THICK);else{0<o[0].x&&(g.fillStyle(s),g.fillRect(0,a.y-WALL_THICK/2,o[0].x,WALL_THICK));for(let t=0;t<o.length;t++){var l,r=o[t],c=0===m&&r.forP1||1===m&&(r.forP1||r.forP2);0<activePowers.vision&&c&&!r.death&&(g.fillStyle(16777215,.3),g.fillRect(r.x-5,a.y-WALL_THICK/2-5,r.w+10,WALL_THICK+10));let e=r.col;0<rouletteTime&&!r.death&&(c=Math.floor((.005*Date.now()+t)%colors.length),e=colors[c]),g.fillStyle(e),g.fillRect(r.x,a.y-WALL_THICK/2,r.w,WALL_THICK),r.vx&&(g.fillStyle(16777215,.7),c=r.x+r.w/2,l=a.y,0<r.vx?g.fillTriangle(c+10,l,c+10+5,l+5,c+10+5,l-5):g.fillTriangle(c-10,l,c-10-5,l+5,c-10-5,l-5)),t<o.length-1&&(c=o[t+1],l=r.x+r.w,0<(r=c.x-l))&&(g.fillStyle(s),g.fillRect(l,a.y-WALL_THICK/2,r,WALL_THICK))}var d=o[o.length-1],d=d.x+d.w;d<W&&(g.fillStyle(s),g.fillRect(d,a.y-WALL_THICK/2,W-d,WALL_THICK))}}if(p1&&p1.alive){trail1.push({x:p1.x,y:p1.y,life:1}),25<trail1.length&&trail1.shift();for(let e=0;e<trail1.length;e++){var p=trail1[e],h=e/(trail1.length-1),u=Math.floor(2+6*h),x=.3+.6*h,h=.3+.7*h,h=(P1_COLOR>>16&255)*h<<16|(P1_COLOR>>8&255)*h<<8|(255&P1_COLOR)*h;g.fillStyle(h,x),g.fillRect(p.x-u/2,p.y-u/2,u,u)}}if(p2&&p2.alive){trail2.push({x:p2.x,y:p2.y,life:1}),25<trail2.length&&trail2.shift();for(let e=0;e<trail2.length;e++){var f=trail2[e],v=e/(trail2.length-1),y=Math.floor(2+6*v),T=.3+.6*v,v=.3+.7*v,v=(P2_COLOR>>16&255)*v<<16|(P2_COLOR>>8&255)*v<<8|(255&P2_COLOR)*v;g.fillStyle(v,T),g.fillRect(f.x-y/2,f.y-y/2,y,y)}}for(e of bugs){var w=.3*Math.sin(.01*Date.now())+.7;g.fillStyle(16711782,w),g.fillCircle(e.x,e.y,e.size),g.fillStyle(16777215,.9),g.fillCircle(e.x-3,e.y-2,2),g.fillCircle(e.x+3,e.y-2,2),g.lineStyle(1,16711782,.8),g.lineBetween(e.x-4,e.y-e.size,e.x-6,e.y-e.size-4),g.lineBetween(e.x+4,e.y-e.size,e.x+6,e.y-e.size-4)}for(t of powerups){var M,S,A=POWERUP_TYPES.indexOf(t.type),A=POWERUP_COLORS[A];"heart"===t.type?(M=.2*Math.sin(.008*Date.now())+1,M=t.size*M,g.fillStyle(A,.9),g.fillCircle(t.x-.3*M,t.y-.2*M,.4*M),g.fillCircle(t.x+.3*M,t.y-.2*M,.4*M),g.fillTriangle(t.x,t.y+.5*M,t.x-.6*M,t.y,t.x+.6*M,t.y),g.fillStyle(A,.3),g.fillCircle(t.x,t.y,.8*M)):(M=.2*Math.sin(.005*Date.now())+1,S=t.size*M,g.lineStyle(2,A,.9),g.strokeCircle(t.x,t.y,S),g.fillStyle(A,.3),g.fillCircle(t.x,t.y,.6*S))}!p1||(P=p1.alive?P1_COLOR:1092,0<activePowers.shield1&&(g.lineStyle(2,65280,.6),g.strokeRect(p1.x-14,p1.y-14,28,28)),0<activePowers.star&&0<invincible1&&(R=.3*Math.sin(.015*Date.now())+.7,g.fillStyle(16776960,.3*R),g.fillCircle(p1.x,p1.y,15)),0<invincible1&&!activePowers.star&&Math.floor(Date.now()/100)%2==0)||(g.fillStyle(P,1),g.fillRect(p1.x-4,p1.y-4,8,8)),!p2||(R=p2.alive?P2_COLOR:1092,0<activePowers.shield2&&(g.lineStyle(2,65280,.6),g.strokeRect(p2.x-14,p2.y-14,28,28)),0<activePowers.star&&0<invincible2&&(P=.3*Math.sin(.015*Date.now())+.7,g.fillStyle(16776960,.3*P),g.fillCircle(p2.x,p2.y,15)),0<invincible2&&!activePowers.star&&Math.floor(Date.now()/100)%2==0)||(g.fillStyle(R,1),g.fillRect(p2.x-4,p2.y-4,8,8)),drawFloatingTexts();for(i of spin1Particles)g.fillStyle(i.col,.9*i.life),g.fillCircle(i.x,i.y,3),g.fillStyle(i.col,.3*i.life),g.fillCircle(i.x,i.y,6);for(n of spin2Particles)g.fillStyle(n.col,.9*n.life),g.fillCircle(n.x,n.y,3),g.fillStyle(n.col,.3*n.life),g.fillCircle(n.x,n.y,6);let b=70;var P=(e,t,a,i,n)=>{t=Math.max(0,Math.min(1,t/a));g.fillStyle(0,.6),g.fillRect(18,n-2,124,16),g.lineStyle(1,16777215,.8),g.strokeRect(20,n,120,12),g.fillStyle(i,.8),g.fillRect(21,n+1,118*t,10)},R=(0<invincible1&&(P(0,invincible1,6,16776960,b),b+=18),0<activePowers.slowmo&&(P(0,activePowers.slowmo,5,65535,b),b+=18),0<activePowers.shield1&&(P(0,activePowers.shield1,8,65280,b),b+=18),0<activePowers.star&&(P(0,activePowers.star,6,16776960,b),b+=18),0<activePowers.vision&&(P(0,activePowers.vision,10,16711935,b),b+=18),0<activePowers.speed&&(P(0,activePowers.speed,8,16746496,b),b+=18),1===m&&(0<invincible2&&(P(0,invincible2,6,16776960,b),b+=18),0<activePowers.shield2)&&(P(0,activePowers.shield2,8,65280,b),b+=18),Math.min(.3+.03*spd,.6));g.fillStyle(0,.7*R),g.fillRect(0,0,W,200),g.fillStyle(0,.5*R),g.fillRect(0,H-200,W,200),g.fillStyle(0,.4*R),g.fillRect(0,0,200,H),g.fillStyle(0,.4*R),g.fillRect(W-200,0,200,H)}function showMenu(){hideAll(),g.clear(),particles=[],menuSel=0,txts.title.setVisible(1),txts.sub.setVisible(1),txts.modeLabel.setVisible(1),txts.modeVal.setVisible(1),txts.diffLabel.setVisible(1),txts.diffVal.setVisible(1),txts.playersLabel.setVisible(1),txts.playersVal.setVisible(1),txts.musicLabel.setVisible(1),txts.musicVal.setVisible(1),txts.rankLabel.setVisible(1),txts.menuInst.setVisible(1),txts.ctrl.setVisible(1),updateMenuHighlight()}function showGame(){hideAll(),(0===m?(txts.p1sc.setVisible(1),txts.help.setVisible(1),txts.lives.setVisible(1),txts.momentum):(txts.p1sc.setVisible(1),txts.p2sc.setVisible(1),txts.help)).setVisible(1),txts.timer.setVisible(1),txts.combo.setVisible(1),txts.menu.setVisible(1),txts.motiv.setAlpha(0).setVisible(0)}function showEnd(){hideAll(),cam.shake(600,.03),cam.flash(200,255,0,0);for(let e=0;e<80;e++){var a=Math.random()*Math.PI*2,i=3*Math.random()+1;particles.push({x:p1?p1.x:W/2,y:p1?p1.y:H/2,vx:Math.cos(a)*i,vy:Math.sin(a)*i,size:Math.floor(4*Math.random()+2),life:.8*Math.random()+.4,col:[16711680,16729156,16746496,P1_COLOR][Math.floor(4*Math.random())],isSquare:!0})}cam.fade(1200,0,0,0),playSound("death"),setTimeout(()=>{var e,a,i;cam.fadeIn(500,0,0,0),txts.go.setText("GAME OVER").setVisible(1),0===m?(i=`
${getMotivationalMessage(e=Math.floor(p1.sc*mom))}

Score: ${e} pts

Portals: ${portals}
Time: ${t.toFixed(1)}s
Max Combo: x${maxCombo}

Mode: ${MODE_NAMES[gm]}
Difficulty: `+DIFF_NAMES[diff],txts.matchStats.setText(i).setVisible(1),i=ranking.length<15||e>ranking[ranking.length-1].score,a=e>hs,i?(a&&(hs=e,saveData()),setTimeout(()=>{txts.go.setVisible(0),txts.matchStats.setVisible(0),sc=3,nameInput="",nameRow=0,nameCol=0,particles=[],txts.namePrompt.setVisible(1),txts.nameInput.setVisible(1),txts.nameLetters.setVisible(1),txts.nameHint.setVisible(1),txts.nameAccept.setVisible(1),updateNameInput()},3e3)):setTimeout(()=>{txts.go.setVisible(0),txts.matchStats.setVisible(0);let t="=== TOP 15 RANKING ===\n\nYou didn't make the cut!\n\n";if(0===ranking.length)t+="No records yet!\n\nPlay to set a record!";else for(let e=0;e<ranking.length;e++){var a=ranking[e];t+=`${e+1}. ${a.name} - ${a.score}pts\n`}t+="\n\nSPACE: Menu",txts.rankView.setText(t).setVisible(1)},2e3)):(i=`
Time: ${t.toFixed(1)}s
Portals: ${portals}

P1 Lives: ${lives1}
P2 Lives: `+lives2,txts.matchStats.setText(i).setVisible(1),p1.alive&&!p2.alive?txts.win.setVisible(1).setText("P1 WINS!"):p2.alive&&!p1.alive?txts.win.setVisible(1).setText("P2 WINS!"):txts.win.setVisible(1).setText("DRAW!"),txts.restart.setText("SPACE: Menu").setVisible(1))},800)}function hideAll(){for(var e in txts)txts[e].setVisible(0)}new Phaser.Game(cfg);